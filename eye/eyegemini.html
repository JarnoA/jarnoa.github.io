<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>Huutomerkin Silmä - Viivat Korjattu</title>
    <style>
        :root {
            --main-color: #961c1c; 
        }

        body {
            background-color: var(--main-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .eye-container {
            position: relative;
            width: 500px;
            height: 500px;
            background: var(--main-color);
            overflow: hidden; 
            box-shadow: inset 0 0 50px rgba(0,0,0,0.7);
            
            /* KORJAUS 1: Lisätään "turvareunus" samalla värillä. 
               Tämä syö mahdolliset valkoiset viivat reunoilta. */
            border: 4px solid var(--main-color); 
            box-sizing: border-box; /* Varmistaa että koko pysyy 500px */
        }

        .sclera {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 580px; 
            height: 580px;
            background: radial-gradient(circle at 50% 50%, #fff 25%, #e0e0e0 60%, #cfcfcf 100%);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.5);
        }

        .iris {
            position: absolute;
            width: 230px; 
            height: 230px;
            background: url('eye2.png') center/contain no-repeat;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0,0,0,0.4);
            transition: transform 0.5s cubic-bezier(0.2, 0, 0.2, 1);
        }

        .shine {
            position: absolute;
            top: 30%;
            left: 62%;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            filter: blur(5px);
            z-index: 5;
        }

        /* KORJAUS 2: Tehdään luomista hieman ylisuuret */
        svg.lids {
            position: absolute;
            /* Siirretään -1% vasemmalle ja ylös... */
            top: -1%;
            left: -1%;
            /* ...ja kasvatetaan 102%:iin. Nyt reunoille ei jää rakoja. */
            width: 102%;
            height: 102%;
            z-index: 10;
            pointer-events: none;
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.8));
        }

        path {
            fill: var(--main-color);
            stroke: none;
        }

        button {
            position: absolute;
            bottom: 20px;
            padding: 15px 30px;
            background: #222; color: #fff;
            border: none; border-radius: 5px;
            cursor: pointer;
            z-index: 100;
            opacity: 0.5;
        }
        button:hover { opacity: 1; }
    </style>
</head>
<body>

    <div class="eye-container">
        <div class="sclera">
            <div class="iris" id="iris"></div>
            <div class="shine"></div>
        </div>

        <svg class="lids" viewBox="0 0 500 500" preserveAspectRatio="none">
            <path id="upper-lid" d="M 0,0 L 500,0 L 500,250 Q 250,20 0,250 Z" />
            <path id="lower-lid" d="M 0,500 L 500,500 L 500,250 Q 250,480 0,250 Z" />
        </svg>
    </div>

    <button id="btn">Käynnistä Mikrofoni</button>

    <script>
        const upperLid = document.getElementById('upper-lid');
        const lowerLid = document.getElementById('lower-lid');
        const iris = document.getElementById('iris');
        const btn = document.getElementById('btn');

        function random(min, max) { return Math.random() * (max - min) + min; }

        function wander() {
            const x = random(-70, 70);
            const y = random(-40, 40);
            iris.style.transform = `translate(${x}px, ${y}px)`;
            setTimeout(wander, random(800, 3000));
        }

        async function init() {
            btn.style.display = 'none';
            wander(); 

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const context = new AudioContext();
                const analyser = context.createAnalyser();
                const source = context.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 256;
                const data = new Uint8Array(analyser.frequencyBinCount);

                const CENTER_Y = 250; 

                function render() {
                    analyser.getByteFrequencyData(data);
                    let vol = data.reduce((a, b) => a + b) / data.length;
                    
                    const maxOpen = 230; 
                    let soundSqueeze = vol * 3.0; 
                    if (soundSqueeze > maxOpen) soundSqueeze = maxOpen;

                    let currentOpenState = maxOpen - soundSqueeze;
                    let topCurve = CENTER_Y - currentOpenState; 
                    let bottomCurve = CENTER_Y + (currentOpenState * 0.7);

                    upperLid.setAttribute('d', 
                        `M 0,0 L 500,0 L 500,${CENTER_Y} Q 250,${topCurve} 0,${CENTER_Y} Z`
                    );

                    lowerLid.setAttribute('d', 
                        `M 0,500 L 500,500 L 500,${CENTER_Y} Q 250,${bottomCurve} 0,${CENTER_Y} Z`
                    );

                    requestAnimationFrame(render);
                }
                render();

                function blink() {
                    upperLid.style.transition = "0.1s";
                    lowerLid.style.transition = "0.1s";
                    upperLid.setAttribute('d', `M 0,0 L 500,0 L 500,250 Q 250,250 0,250 Z`);
                    lowerLid.setAttribute('d', `M 0,500 L 500,500 L 500,250 Q 250,250 0,250 Z`);

                    setTimeout(() => {
                        upperLid.style.transition = "none";
                        lowerLid.style.transition = "none";
                    }, 150);
                    setTimeout(blink, random(3000, 8000));
                }
                blink();

            } catch (e) {
                console.error(e);
                alert("Mikrofoni tarvitaan.");
            }
        }
        btn.onclick = init;
    </script>
</body>
</html>